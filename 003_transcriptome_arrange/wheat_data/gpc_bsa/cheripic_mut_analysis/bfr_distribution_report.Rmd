---
output:
  html_document:
    fig_caption: yes
    theme: spacelab
    toc: no
---
# **polyploid bulk frequency ratios (BFRs)**

Load libraries and the data
```{r setup, include=FALSE}
# load the required libraries and functions
library(knitr)
library(markdown)
#opts_chunk$set(dev = 'pdf')
library(grid)
library(gridExtra)
library(ggplot2)
library(MASS)

## cusotom ggplot theme edits
source('~/git-hub-repos/shyamrallapalli/mutations_hts_noref/lib/ggplot_theme.R')

```

...     

Bulk frequency ratio (BFR) is the ratio of allele frequency between phenotype of interest parent and wildtype parent or bulks

Was used in studies on polyploid organisms to isolate interesting candidates in the homelogues chormosomes.
Further details are available at [http://bmcplantbiol.biomedcentral.com/articles/10.1186/1471-2229-12-14](http://bmcplantbiol.biomedcentral.com/articles/10.1186/1471-2229-12-14)

...

#### box plot of bfr

```{r boxplot-bfr, echo=FALSE, fig.width=2, fig.height=5}
data <- read.delim(file="bfr_ratios_table.txt", header=TRUE)

a = ''
for (i in 1:nrow(data)) {
  if (data$bfr[i] > 0 ) {
    a = append(a, rep(data$bfr[i], data$contigs[i]))
  }
}
# remove first empty element
a = as.numeric(a[-1])
# b = a[a > 0]

df1 = data.frame(x=rep(">zero", length(a)), y=a)
colnames(df1) <- c("bfrs", "value")
ggplot(df1, aes(x=bfrs, y=value, fill=bfrs)) + geom_boxplot() + scale_y_log10() +
  labs(x ="bfr", y="values", main=NULL) + mytheme + theme(legend.position="none")

```


...


...

#### fitting distribtuion to the BFRs

```{r fit-distr, echo=FALSE, fig.width=12, fig.height=6}

dens = density(a, bw="bcv", kernel="gaussian")
bfrs <- data.frame(x=dens$x, y=dens$y)

fit1 <- fitdistr(a, "lognormal")
lnorm_r <- rlnorm(length(a), as.numeric(fit1$estimate['meanlog']), as.numeric(fit1$estimate['sdlog']))
den1 <- density(lnorm_r)
ln_model <- data.frame(x=den1$x, y=den1$y)

fit2 <- fitdistr(a, "exponential")
expon_r <- rexp(length(a), as.numeric(fit2$estimate['rate']))
den2 <- density(expon_r)
exp_model <- data.frame(x=den2$x, y=den2$y)

fit3 <- fitdistr(a, "normal")
normal_r <- rnorm(length(a), as.numeric(fit3$estimate['mean']), as.numeric(fit3$estimate['sd']))
den3 <- density(normal_r)
normal_model <- data.frame(x=den3$x, y=den3$y)

ggplot() + geom_line(data=bfrs, aes(x=x, y=y, colour="bfrs"), size=1) +
  geom_line(data=exp_model, aes(x=x, y=y, colour="exponential fit"), size=1) +
  geom_line(data=normal_model, aes(x=x, y=y, colour="normal fit"), size=1) +
  geom_line(data=ln_model, aes(x=x, y=y, colour="log normal fit"), size=1) +
  scale_y_sqrt() + mytheme + theme(legend.position=c(0.85,0.9)) +
  labs(x ="contig lengths", y="density", main=NULL)

```



### qq plots using fitted distributions

```{r qqplot, echo=FALSE, fig.width=12, fig.height=4}
qqline2 <- function(x, y, probs = c(0.25, 0.75), qtype = 7, ...){
      stopifnot(length(probs) == 2)
      x2 <- quantile(x, probs, names=FALSE, type=qtype, na.rm = TRUE)
      y2 <- quantile(y, probs, names=FALSE, type=qtype, na.rm = TRUE)
      slope <- diff(y2)/diff(x2)
      int <- y2[1L] - slope*x2[1L]
      abline(int, slope, ...)
    }

leg_r2 <- function(k){
  legend(x = "topleft", bty = "n",
         legend = substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2,
                             list(a = format(coef(k)[1], digits = 2),
                                  b = format(coef(k)[2], digits = 2),
                                  r2 = format(summary(k)$r.squared, digits = 3))))
}
par(mfrow=c(1,3), mar=c(5,5,1,0.5))
V=qqplot(a, expon_r, xlab="bfrs", ylab="exponential fit", cex.lab=1.5, cex.axis=1.5)
qqline2(a, expon_r)
k=lm(V$y ~ V$x)
leg_r2(k)
V=qqplot(a, lnorm_r, xlab="bfrs", ylab="lognormal fit", cex.lab=1.5, cex.axis=1.5)
qqline2(a, lnorm_r)
k=lm(V$y ~ V$x)
leg_r2(k)
V=qqplot(a, normal_r, xlab="bfrs", ylab="normal fit", cex.lab=1.5, cex.axis=1.5)
qqline2(a, normal_r)
k=lm(V$y ~ V$x)
leg_r2(k)

```


##### from the qqplots of the BFRs vs fitted data; these BFRs are best summarised by a log-normal distribution, followed by exponential distribution


